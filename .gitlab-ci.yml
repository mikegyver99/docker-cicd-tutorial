image: docker:latest
services:
    - docker:dind

variables:
    WORK_DIR: ${CI_PROJECT_NAME}
    BRANCH: ${CI_COMMIT_REF_NAME}
    REGISTRY: registry.gitlab.com/maltodextrin99/gitlab-cicd-tutorial
    
stages:
    - build
    - test

build_docker_image:
    stage: build
    script:
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
        - docker build -t $REGISTRY .
        - docker push $REGISTRY
    tags:
        - docker_executor

test_docker_image:
    stage: test
    script:
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
        - docker pull $REGISTRY
        - docker run --name=$BRANCH -p 80:8080 -i $REGISTRY npm run ci
    tags:
        - docker_executor       
